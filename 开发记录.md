# Dify 插件开发记录

## 项目概述
本文档记录 Dify 插件开发过程中的关键步骤、决策和问题解决方案。

## 开发环境
- 操作系统: macOS (Darwin arm64)
- 开发工具: Visual Studio Code, Git
- Dify 插件 CLI 版本: 0.0.1b67

## 开发时间线

### [2024-03-18]
- 初始化插件项目
- 设置基本结构
- 实现 MCP 服务器基础功能
- 配置远程 Git 仓库
- 完成端点基础测试
- 添加 GET 端点支持
- 重构 POST 端点命名，保持一致性
- 更新端点组配置

## 功能清单
- [x] 基础 MCP 服务器功能
- [x] Dify Workflow 集成
- [x] GET 端点支持（状态查询）
- [ ] 完整的 SSE 流式响应
- [ ] 认证和安全特性

## 遇到的问题及解决方案
1. **MCP 请求格式问题**:
   - 描述: 客户端请求格式与服务器期望格式不匹配
   - 解决方案: 调整 JSON 请求格式，将参数封装在 `responseValues` 对象中

2. **模型凭证问题**:
   - 描述: 测试时出现 "Model claude-3-5-sonnet-20241022 credentials is not initialized" 错误
   - 解决方案: 需要在 Dify 应用中正确配置模型凭证

## API 文档
插件提供的 API 及其使用方法:

### POST Workflow API
- **端点**: `/difyapp_as_mcp_server`
- **方法**: POST
- **请求格式**:
```json
{
  "responseValues": {
    "title": {
      "value": "查询内容"
    },
    "language": {
      "value": "语言选择"
    }
  }
}
```
- **响应格式**:
```json
{
  "status": "success",
  "workflow_response": {
    "data": {
      "outputs": {
        "output": "生成的内容"
      },
      "status": "succeeded"
    }
  }
}
```

### GET Status API
- **端点**: `/difyapp_as_mcp_server`
- **方法**: GET
- **请求参数**: 支持通过URL查询参数传递
- **响应格式**:
```json
{
  "status": "success",
  "message": "Dify MCP Server is running",
  "app_id": "应用ID",
  "query_params": {
    "param1": "value1",
    "param2": "value2"
  }
}
```

## 测试记录
### 2024-03-18 测试
- **测试用例**: 使用 curl 请求发送标题 "kanye west"，语言 "English"
- **请求命令**: 
```bash
curl -X POST "https://jar8zeuq1rs88qdz.ai-plugin.io/difyapp_as_mcp_server" \
     -H "Content-Type: application/json" \
     -d '{"responseValues": {"title": {"value": "kanye west"}, "language": {"value": "English"}}}'
```
- **测试结果**: 成功，返回了关于 Kanye West 的详细 HTML 内容
- **问题**: 初始测试因模型凭证问题失败，第二次测试成功

### 2024-03-18 GET端点测试
- **测试用例**: 使用 curl 请求获取服务器状态
- **请求命令**:
```bash
curl -X GET "https://jar8zeuq1rs88qdz.ai-plugin.io/difyapp_as_mcp_server?param=test"
```
- **测试结果**: 成功，返回服务器运行状态和应用ID信息

## 部署说明
如何部署和使用该插件:

1. 在 Dify 平台中安装插件
2. 配置插件参数，包括:
   - 应用 ID
   - API 密钥
3. 端点可通过 HTTP 客户端或 MCP 兼容客户端访问

## 未来计划
- 实现完整的流式响应支持
- 添加更多配置选项
- 支持更多 Dify 应用类型
- 优化错误处理
- 添加认证机制

## 路线图
### Step 1: 实现dify workflow 的基础反向调用
- 描述: 实现dify workflow的基础反向调用功能，确保插件能够正确地与dify workflow进行交互。
- 目标: 完成基础反向调用的实现，确保插件能够在dify workflow中正确运行。
- 状态: ✅ 已完成

### Step 2: 将反向调用的接口根据mcp开发标准变成符合mcp的协议
- 描述: 根据mcp开发标准，将插件的反向调用接口修改为符合mcp协议的接口，确保插件能够与mcp客户端进行正确的交互。
- 目标: 完成mcp协议接口的修改，确保插件能够与mcp客户端进行正确的交互。
- 状态: ✅ 已完成

### Step 3: 添加GET端点支持
- 描述: 添加GET端点支持，允许客户端查询服务器状态和应用信息，提升API完整性。
- 目标: 完成GET端点的实现，确保客户端可以方便地查询服务器状态。
- 状态: ✅ 已完成

### Step 4: 实现一个webapp（说明书）
- 描述: 实现一个webapp，用于展示插件的使用说明和示例，方便用户快速上手使用插件。
- 目标: 完成webapp的实现，确保用户能够通过webapp快速了解插件的使用方法。
- 状态: 📅 计划中

## 参考资料
- [MCP 协议文档](https://www.anthropic.com/claude/model-context-protocol)
- [Dify 插件开发文档](https://docs.dify.ai/v/zh-hans/advanced/plugin-system)
- [Dify Workflow API 文档](https://docs.dify.ai/v/zh-hans/api-reference/workflow-api) 

